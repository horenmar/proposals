\documentclass{wg21}

\input{glyphtounicode}
\pdfgentounicode=1

\usepackage{xcolor}
\usepackage{soul}
\usepackage{ulem}
\usepackage{fullpage}
\usepackage{parskip}
\usepackage{csquotes}
\usepackage{relsize}      % provide relative font size changes
\usepackage{textcomp}     % provide \text{l,r}angle
\usepackage{mathrsfs}     % mathscr font
\usepackage{microtype}

\title{Make Pseudo-random Numbers Portable}
\docnumber{PXXXXR0}
\audience{LEWGI}
\author{Martin Hořeňovský}{martin.horenovsky@gmail.com}

\usepackage[inner=2cm,outer=2cm]{geometry}

\begin{document}
\maketitle

%\begin{flushright}
%\hfill \break
%\hfill \break
%\textit{Some tagline?}
%\end{flushright}

% URNGs are portable:
% http://eel.is/c++draft/rand#predef

\hypertarget{introduction}{%
    \section{Introduction}\label{introduction}}

The C++ standard library provides a set of utilities to generate
pseudo-random numbers in a range of user's choosing. This is done
by applying a type that represents the desired statistical distribution
(e.g. \texttt{uniform\_int\_distribution}) with a type conforming
to the Uniform Random Bit Generator (URBG) concept (e.g. \texttt{mt19937}).

This makes the standard-provided facilities highly customizable, but they
are rarely used because the generated numbers are not reproducible across
different platforms. The reason for this is that the output of
standard-provided distributions\footnote{The output of standard-provided
URBGs is portable due to a happy accident during the original
\texttt{<random>} standardization} is implementation-specified and thus
can (and does) differ across implementations.

This paper proposes changes that would allow users to use these facilities
for domains that require cross-platform reproducibility, such as testing,
simulations, and games.


\hypertarget{motivation}{%
    \section{Motivation}\label{motivation}}

A straightforward ``Hello world'' of random number generation looks something
like this:

% https://godbolt.org/z/dB7H_2
\begin{codeblock}
#include <random>
#include <iostream>

int main() {
    std::mt19937 urbg;
    std::uniform_int_distribution<> dist(0, 100);
    std::cout << dist(urbg) << '\n';
}
\end{codeblock}

On my machine\footnote{MSVC bundled with VS 16.4.0}, this code always
prints out \texttt{53}. \href{https://godbolt.org/z/dB7H_2}{On other
popular platforms, the code prints \texttt{82}\footnote{libstdc++} and
\texttt{92}\footnote{libc++}}. This
difference in outputs makes the standard-provided \texttt{<random>}
facilities unusable in contexts where a cross-platform reproducibility
is required, such as procedural generation and physics simulations.

However, cross-platform reproducibility is useful even in cases
where it is not required, such as property-based tests. For property-based
testing, it is desirable for a fixed seed to generate the same
test case across different platforms, so that developers can share
relevant seeds between themselves.

Because of this, \texttt{<random>} is currently unusable in many
domains and applications, and if we want to change that, we need
to ensure that a deterministically seeded code, such as the snippet
above, generates the same numbers on all platforms.


\hypertarget{possible-solutions}{%
    \section{Possible solutions}\label{possible-solutions}}

This section outlines possible solutions to the problem explained above,
together with their advantages and disadvantages as seen by the author of
this paper.

\hypertarget{standardize-implementation}{%
    \subsection{Standardize implementation for current distributions}\label{possible-solutions}}

One possibility (the one prefered by the author), is to mandate the specific
implementation of all distributions in \texttt{<random>}. This option
has two advantages, in that

\begin{itemize}
    \item it retroactively fixes broken code
    \item it does not introduce further maintenance burden on implementations of the standard library
\end{itemize}

They are also disadvantages at the same time, in that

\begin{itemize}
    \item it is a (potentially) breaking change
    \item it forbids implementations from providing the fastest possible code for their platform
\end{itemize}

The backward compatibility argument is debatable, as at least one
implementor does not see the change to distribution output as breaking
unless it forces a full ABI break\cite{msvc-github}.

The second disadvantage can be fixed by adding \texttt{fast_meow_distribution}s
to the standard.


\hypertarget{portable-overloads}{%
    \subsection{Provide \texttt{portable_meow_distributions}}\label{portable-overloads}}

The other possibility is to add \texttt{portable_meow_distributions}
to \texttt{<random>}. This option is essentially the inverse solution
of the first possibility, in that the old code is left as it was, and
a new set of types is provided for portability.

However, this option is less desirable one as it makes the simpler code
do the wrong thing, and is harder to teach.



\hypertarget{non-goals}{%
    \section{Non-goals}\label{non-goals}}

There are several other problems with \texttt{<random>} as it is currently
standardized, and this paper intentionally does not try to fix any of them.
This is because there are other papers that target those issues, and we
should not let fixing an issue get bogged down because of a lack of consensus
on other issues.

Note that this paper also intentionally does not provide code nor wording
in this version, as I think that consensus on the desired direction should
come first.


\begin{thebibliography}{9}

    \bibitem{msvc-github}
    Casey Carter
    \emph{Issue optimizing the implementation of \texttt{uniform_int_distribution}}
    \url{https://github.com/microsoft/STL/issues/178#issuecomment-553059724}

\end{thebibliography}

\end{document}
